name: Build and test library
on: [push]
defaults:
  run:
    shell: pwsh
jobs:
  # Linux tests are disabled - build-core.ps1 script not found
  # Keeping Windows build test only for now
  windows-tests:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          8.0.x
          6.0.x

    - name: Install .NET Framework targeting packs
      shell: pwsh
      run: |
        # Install .NET Framework developer packs for building
        choco install netfx-4.7.2-devpack -y --no-progress

    - name: Build the library
      shell: pwsh
      run: |
        ./build/build.ps1

    - name: Test module import
      shell: pwsh
      run: |
        Import-Module ./dbatools.library.psd1 -Force
        $module = Get-Module dbatools.library
        Write-Host "Loaded dbatools.library version: $($module.Version)"
        Write-Host "Module path: $($module.Path)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dbatools-library
        path: |
          lib/
          dbatools.library.psd1
          dbatools.library.psm1
          private/
          LICENSE
